name: Deployment Cleanup & Smoke Test

on:
  repository_dispatch:
    types: [ecs_deploy_success, ecs_deploy_failed]

permissions:
  contents: read
  deployments: write

jobs:
  smoke-test:
    name: Async Smoke Test & Cleanup
    runs-on: ubuntu-latest
    if: github.event.action == 'ecs_deploy_success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Get ALB DNS
        id: alb
        env:
          PROJECT_NAME: shoreexplorer
          ENVIRONMENT: ${{ github.event.client_payload.environment }}
          PROD_DOMAIN: ${{ secrets.PROD_DOMAIN }}
          TEST_DOMAIN: ${{ secrets.TEST_DOMAIN }}
        run: |
          if [[ "$ENVIRONMENT" == "prod" ]]; then
            CUSTOM_DOMAIN="${PROD_DOMAIN:-}"
          else
            CUSTOM_DOMAIN="${TEST_DOMAIN:-}"
          fi

          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names "${PROJECT_NAME}-${ENVIRONMENT}-alb" \
            --query "LoadBalancers[0].DNSName" \
            --output text 2>/dev/null || echo "")

          if [[ -n "$CUSTOM_DOMAIN" ]]; then
            [[ "$ENVIRONMENT" == "test" ]] && URL="https://test.${CUSTOM_DOMAIN}" || URL="https://${CUSTOM_DOMAIN}"
          elif [[ -n "$ALB_DNS" && "$ALB_DNS" != "None" ]]; then
            URL="https://${ALB_DNS}"
          else
            URL="http://localhost:8001"
          fi
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Run Smoke Test
        run: |
          URL="${{ steps.alb.outputs.url }}"
          echo "Running smoke tests against ${URL}"
          
          # Wait a few seconds for health checks to be fully ready
          sleep 15
          
          # Check API health
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "${URL}/api/health" --max-time 15 || echo "000")
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "✅ Health check passed (HTTP $HTTP_CODE)"
          else
            echo "❌ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Check frontend
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "${URL}/" --max-time 15 || echo "000")
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "✅ Frontend accessible (HTTP $HTTP_CODE)"
          else
            echo "❌ Frontend check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Notify Success
        if: success()
        run: echo "Deployment for ${{ github.event.client_payload.environment }} fully stable and verified."

  handle-failure:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    if: github.event.action == 'ecs_deploy_failed'
    steps:
      - name: Notify Failure
        run: |
          echo "❌ Deployment for ${{ github.event.client_payload.environment }} failed to stabilize in AWS."
          # Here we could trigger a rollback or send an alert
          exit 1
