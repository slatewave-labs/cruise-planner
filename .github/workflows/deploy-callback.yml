name: Deployment Cleanup & Smoke Test

on:
  repository_dispatch:
    types: [codedeploy_deploy_success, codedeploy_deploy_failed]

permissions:
  contents: read
  deployments: write
  actions: write

jobs:
  gate-approval:
    name: Approve Deployment Gate
    runs-on: ubuntu-latest
    if: github.event.action == 'codedeploy_deploy_success'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Check if backend CodeDeploy deployment succeeded
        id: stability
        env:
          PROJECT_NAME: shoreexplorer
          ENVIRONMENT: ${{ github.event.client_payload.environment }}
        run: |
          # Only backend uses CodeDeploy (frontend is deployed to S3/CloudFront).
          # Approve the gate when the backend deployment group has succeeded.
          APP_NAME="${PROJECT_NAME}-${ENVIRONMENT}"
          CODEDEPLOY_APP="${APP_NAME}-codedeploy"
          all_succeeded=true

          DG="${APP_NAME}-backend-dg"
          DEPLOY_ID=$(aws deploy list-deployments \
            --application-name "$CODEDEPLOY_APP" \
            --deployment-group-name "$DG" \
            --include-only-statuses "Succeeded" \
            --query "deployments[0]" --output text \
            --region "${{ secrets.AWS_REGION || 'us-east-1' }}" 2>/dev/null || echo "")

          if [[ -z "$DEPLOY_ID" || "$DEPLOY_ID" == "None" ]]; then
            echo "${DG}: ⏳ no successful deployment yet — waiting for next callback"
            all_succeeded=false
          else
            echo "${DG}: ✅ latest deployment succeeded (${DEPLOY_ID})"
          fi

          echo "all_succeeded=${all_succeeded}" >> "$GITHUB_OUTPUT"

      - name: Approve deployment gate (both services deployed)
        if: steps.stability.outputs.all_succeeded == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CALLBACK_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const environment = context.payload.client_payload.environment;
            const gateName = `${environment}-post-deploy`;

            // Find workflow runs waiting for environment approval
            const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'waiting',
              per_page: 20,
            });

            console.log(`Looking for runs waiting on environment: ${gateName}`);

            for (const run of workflow_runs) {
              try {
                const { data: pending } = await github.rest.actions.getPendingDeployments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id,
                });

                const gate = pending.find(d => d.environment.name === gateName);
                if (gate) {
                  await github.rest.actions.reviewPendingDeployments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                    environment_ids: [gate.environment.id],
                    state: 'approved',
                    comment: `CodeDeploy Blue/Green deployment for ${environment} backend succeeded. Frontend deployed to S3/CloudFront.`,
                  });
                  console.log(`✅ Approved deployment gate '${gateName}' for run #${run.id}`);
                  return;
                }
              } catch (e) {
                // This run may not have pending deployments — continue searching
              }
            }

            console.log(`ℹ️  No waiting runs found for environment '${gateName}'.`);

  handle-failure:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    if: github.event.action == 'codedeploy_deploy_failed'

    steps:
      - name: Reject deployment gate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CALLBACK_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const environment = context.payload.client_payload.environment;
            const gateName = `${environment}-post-deploy`;

            const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'waiting',
              per_page: 20,
            });

            for (const run of workflow_runs) {
              try {
                const { data: pending } = await github.rest.actions.getPendingDeployments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id,
                });

                const gate = pending.find(d => d.environment.name === gateName);
                if (gate) {
                  await github.rest.actions.reviewPendingDeployments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                    environment_ids: [gate.environment.id],
                    state: 'rejected',
                    comment: `CodeDeploy deployment for ${environment} failed. Deployment group: ${context.payload.client_payload.deployment_group || 'unknown'}.`,
                  });
                  console.log(`❌ Rejected deployment gate '${gateName}' for run #${run.id}`);
                  return;
                }
              } catch (e) {
                // Continue searching
              }
            }

            console.log(`ℹ️  No waiting runs found for environment '${gateName}'.`);

      - name: Notify failure
        run: |
          echo "❌ CodeDeploy deployment for ${{ github.event.client_payload.environment }} failed."
          echo "   Deployment group: ${{ github.event.client_payload.deployment_group || 'unknown' }}"
          exit 1
