name: Deployment Cleanup & Smoke Test

on:
  repository_dispatch:
    types: [ecs_deploy_success, ecs_deploy_failed]

permissions:
  contents: read
  deployments: write
  actions: write

jobs:
  gate-approval:
    name: Approve Deployment Gate
    runs-on: ubuntu-latest
    if: github.event.action == 'ecs_deploy_success'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Check if both ECS services are stable
        id: stability
        env:
          PROJECT_NAME: shoreexplorer
          ENVIRONMENT: ${{ github.event.client_payload.environment }}
        run: |
          CLUSTER="${PROJECT_NAME}-${ENVIRONMENT}-cluster"
          SERVICES=("${PROJECT_NAME}-${ENVIRONMENT}-backend" "${PROJECT_NAME}-${ENVIRONMENT}-frontend")
          all_stable=true

          for svc in "${SERVICES[@]}"; do
            svc_info=$(aws ecs describe-services \
              --cluster "$CLUSTER" --services "$svc" \
              --query "services[0].{active: length(deployments[?status!='INACTIVE']), running: runningCount, desired: desiredCount}" \
              --output json 2>/dev/null || echo '{"active":0,"running":0,"desired":1}')
            active=$(echo "$svc_info" | jq -r '.active')
            running=$(echo "$svc_info" | jq -r '.running')
            desired=$(echo "$svc_info" | jq -r '.desired')
            echo "${svc}: active_deployments=${active}, running=${running}, desired=${desired}"
            if [[ "$active" != "1" || "$running" != "$desired" ]]; then
              all_stable=false
              echo "  ⏳ ${svc} is not yet stable — waiting for next callback"
            fi
          done

          echo "all_stable=${all_stable}" >> "$GITHUB_OUTPUT"

      - name: Approve deployment gate (both services stable)
        if: steps.stability.outputs.all_stable == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CALLBACK_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const environment = context.payload.client_payload.environment;
            const gateName = `${environment}-post-deploy`;

            // Find workflow runs waiting for environment approval
            const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'waiting',
              per_page: 20,
            });

            console.log(`Looking for runs waiting on environment: ${gateName}`);

            for (const run of workflow_runs) {
              try {
                const { data: pending } = await github.rest.actions.getPendingDeployments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id,
                });

                const gate = pending.find(d => d.environment.name === gateName);
                if (gate) {
                  await github.rest.actions.reviewPendingDeployments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                    environment_ids: [gate.environment.id],
                    state: 'approved',
                    comment: `ECS deployment for ${environment} is fully stable (both backend and frontend).`,
                  });
                  console.log(`✅ Approved deployment gate '${gateName}' for run #${run.id}`);
                  return;
                }
              } catch (e) {
                // This run may not have pending deployments — continue searching
              }
            }

            console.log(`ℹ️  No waiting runs found for environment '${gateName}' — the cleanup job may have already started via polling.`);

  handle-failure:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    if: github.event.action == 'ecs_deploy_failed'

    steps:
      - name: Reject deployment gate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CALLBACK_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const environment = context.payload.client_payload.environment;
            const gateName = `${environment}-post-deploy`;

            const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'waiting',
              per_page: 20,
            });

            for (const run of workflow_runs) {
              try {
                const { data: pending } = await github.rest.actions.getPendingDeployments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id,
                });

                const gate = pending.find(d => d.environment.name === gateName);
                if (gate) {
                  await github.rest.actions.reviewPendingDeployments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                    environment_ids: [gate.environment.id],
                    state: 'rejected',
                    comment: `ECS deployment for ${environment} failed to stabilize in AWS.`,
                  });
                  console.log(`❌ Rejected deployment gate '${gateName}' for run #${run.id}`);
                  return;
                }
              } catch (e) {
                // Continue searching
              }
            }

            console.log(`ℹ️  No waiting runs found for environment '${gateName}'.`);

      - name: Notify failure
        run: |
          echo "❌ Deployment for ${{ github.event.client_payload.environment }} failed to stabilize in AWS."
          exit 1

